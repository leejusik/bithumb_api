<!DOCTYPE html>
<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Page Title</title>
	<link rel="stylesheet" href="./css/index.css">
	<script src="./js/jquery-3.3.1.js"></script>
	<script src="./js/Chart.min.js"></script>
	<script src="./js/index_chart.js"></script>
	<script src="./js/index_bithumb.js"></script>
</head>

<body>
	<div id="header">
		<div id="titleFrame">Virual Currency Info</div>
	</div>
	<div id="mainFrame">
		<div id="coinListFrame">
			<div id="sortButton" onclick="sortCoin()">Sort</div>
		</div>
		<div id="chartFrame"> <canvas id="chart"></canvas> </div>
	</div>
	<script>
		let coinListFrame = $('#coinListFrame')
		let coinList = ['btc', 'eos', 'ada'].map(coin => coin.toUpperCase())
		let currentCoin = coinList[0]
		coinList.forEach(coin => coinListFrame.append('<div class="coinListItem" id="coinInfo' + coin + '" onclick="onClickInfo(\'' + coin + '\')">' +
			'<div class="coinInfoName" id="coinInfo' + coin + 'Name">' + coin + '</div>' +
			'<div class="coinInfoDiff" id="coinInfo' + coin + 'Diff">Dif</div></div>'))
		let coinInfoItem = coinList.reduce((arr, coin) => { arr[coin] = $('#coinInfo' + coin); return arr }, [])
		let coinInfoName = coinList.reduce((arr, coin) => { arr[coin] = $('#coinInfo' + coin + 'Name'); return arr }, [])
		let coinInfoDiff = coinList.reduce((arr, coin) => { arr[coin] = $('#coinInfo' + coin + 'Diff'); return arr }, [])
		const coinManagers = coinList.map(coin => new CoinManager(coin, updated, signalFunction))

		var chartData = []
		var ctx = document.getElementById("chart").getContext('2d');
		var chart = chart(ctx)

		function onClickInfo(item) {
			currentCoin = item
		}

		function signalFunction(bef, cur) {
			return {
				signA: cur.prices - cur.mal > 0 && bef.prices - bef.mal < 0,
				signB: cur.prices - cur.mal < 0 && bef.prices - bef.mal > 0
			}
		}

		function updated(manager) {
			if (manager.coin == currentCoin) {
				var data = manager.getData(60)
				chart.options.title.text = '[ ' + manager.coin + ']'
				chart.data.labels = data.times
				chart.data.datasets[0].data = data.prices
				chart.data.datasets[1].data = data.mal

				chart.update()
				showSignal(data, 'signA', '#aa0000', 'Sell')
				showSignal(data, 'signB', '#0000aa', 'Buy')
			}
			coinInfoDiff[manager.coin].text(manager.recent['24H_fluctate_rate'])
			coinInfoItem[manager.coin].data('flucate', manager.recent['24H_fluctate_rate'])
		}

		function showSignal(data, name, color, text) {
			var meta = chart.getDatasetMeta(1);
			data.times.forEach(index => {
				if (!data.signals[name]) return
				var x = (meta.data[index]._model.x + meta.data[index - 1]._model.x) / 2;
				var y = (meta.data[index]._model.y + meta.data[index - 1]._model.y) / 2;
				ctx.fillStyle = color
				ctx.fillRect(x - 3, y - 3, 6, 6)
				ctx.fillStyle = '#aaaaaa'
				ctx.fillText(text, x + 5, y);
			})
		}

		function sortCoin() {
			console.log($('.coinListItem').eq())
			$('.coinListItem').eq().sort(function (a, b) {
				console.log(a, b)
			}).appendTo('#coinListFrame');
		}
	</script>
</body>

</html>